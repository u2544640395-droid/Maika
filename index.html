<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maika - Official</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">

    <style>
        /* --- BUSINESS DESIGN SYSTEM --- */
        * { font-family: 'Plus Jakarta Sans', sans-serif; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #0f172a; color: white; height: 100vh; width: 100vw; overflow: hidden; margin: 0; }
        .hidden { display: none !important; }
        
        /* UI Kit */
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .btn-primary { background: #6366f1; color: white; font-weight: 700; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); transition: transform 0.1s; }
        .btn-primary:active { transform: scale(0.97); }
        .btn-gold { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: 700; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
        
        /* Inputs */
        .input-field { width: 100%; background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; padding: 12px; rounded-xl; color: white; outline: none; transition: border 0.3s; }
        .input-field:focus { border-color: #6366f1; }
        
        /* Animations */
        .screen { position: absolute; inset: 0; opacity: 0; visibility: hidden; transition: opacity 0.3s; z-index: 10; display: flex; flex-direction: column; background: #0f172a; }
        .screen.active { opacity: 1; visibility: visible; z-index: 20; }
        
        /* Map UI */
        #map-view { position: absolute; inset: 0; z-index: 1; }
        .car-marker-icon { transition: all 1s linear; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); }
        
        /* Sheets */
        .bottom-sheet { position: absolute; bottom: 0; left: 0; width: 100%; background: #1e293b; border-radius: 24px 24px 0 0; padding: 24px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 50; max-height: 85vh; overflow-y: auto; box-shadow: 0 -10px 40px rgba(0,0,0,0.5); }
        .bottom-sheet.open { transform: translateY(0); }
        
        /* Toast */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: #10b981; color: white; padding: 12px 24px; rounded-full; font-weight: 600; z-index: 9999; transition: transform 0.3s; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3); font-size: 14px; white-space: nowrap; }
        .toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div id="toast" class="toast"><i class="fas fa-check-circle mr-2"></i> <span id="toastMsg">Message</span></div>

    <div class="screen active" id="splashScreen">
        <div class="m-auto text-center">
            <div class="w-24 h-24 bg-indigo-600 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-2xl shadow-indigo-500/50"><i class="fas fa-bolt text-4xl"></i></div>
            <h1 class="text-3xl font-bold tracking-tight">MAIKA</h1>
            <p class="text-indigo-300 text-sm font-medium tracking-wider mt-1">MOBILITÉ PREMIUM</p>
        </div>
    </div>

    <div class="screen" id="authScreen">
        <div class="flex-1 flex flex-col justify-end p-6 pb-12 bg-gradient-to-b from-[#0f172a] to-[#1e1b4b]">
            <h1 class="text-4xl font-bold mb-2">Bienvenue.</h1>
            <p class="text-gray-400 mb-8">La plateforme VTC & Location de référence.</p>
            
            <button onclick="startAuth('client')" class="btn-primary w-full py-4 rounded-xl mb-4 text-lg">Je suis Client</button>
            <button onclick="startAuth('driver')" class="btn-gold w-full py-4 rounded-xl text-lg flex items-center justify-center gap-2">
                <i class="fas fa-id-card"></i> Espace Prestataire
            </button>
        </div>
    </div>

    <div class="screen" id="phoneScreen">
        <div class="p-6 pt-12">
            <button onclick="nav('authScreen')" class="text-gray-400 mb-8"><i class="fas fa-arrow-left"></i> Retour</button>
            <h2 class="text-2xl font-bold mb-2">Votre Numéro</h2>
            <p class="text-gray-400 text-sm mb-6">Nous allons vérifier votre compte WhatsApp.</p>
            
            <div class="flex gap-3 mb-6">
                <div class="bg-slate-800 p-4 rounded-xl text-gray-400">+261</div>
                <input type="tel" id="phoneInput" placeholder="34 00 000 00" class="input-field text-lg font-bold tracking-wider">
            </div>
            <button onclick="checkUser()" class="btn-primary w-full py-4 rounded-xl">Continuer</button>
        </div>
    </div>

    <div class="screen" id="registerScreen">
        <div class="p-6 pt-10 h-full flex flex-col">
            <h2 class="text-2xl font-bold mb-1">Création de Compte</h2>
            <p class="text-indigo-400 text-sm mb-6 font-bold uppercase" id="regRoleDisplay">CLIENT</p>
            
            <div class="flex-1 overflow-y-auto space-y-4 pb-4">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="regName" placeholder="Prénom" class="input-field">
                    <input type="text" id="regSurname" placeholder="Nom" class="input-field">
                </div>

                <div id="driverFields" class="hidden space-y-4 border-t border-gray-700 pt-4 mt-4">
                    <p class="text-xs text-gray-400 uppercase font-bold">Informations Véhicule</p>
                    
                    <select id="regService" class="input-field bg-slate-800">
                        <option value="urbain">Course Urbaine</option>
                        <option value="location">Location / Province</option>
                        <option value="mixte">Mixte</option>
                    </select>

                    <select id="regVehicleType" class="input-field bg-slate-800" onchange="toggleMotoFields()">
                        <option value="standard">Voiture Standard</option>
                        <option value="premium">SUV / 4x4 Premium</option>
                        <option value="moto">Moto</option>
                    </select>

                    <input type="text" id="regModel" placeholder="Marque & Modèle (ex: Golf 4)" class="input-field">
                    <input type="text" id="regLicense" placeholder="Numéro Permis" class="input-field">
                    
                    <div id="motoFields" class="hidden">
                        <input type="text" id="regCin" placeholder="Numéro CIN (Obligatoire Moto)" class="input-field">
                    </div>

                    <div class="bg-indigo-900/30 p-4 rounded-xl border border-indigo-500/30 text-xs text-indigo-300">
                        <i class="fas fa-info-circle mr-1"></i>
                        Les documents (Photo permis, Carte grise, Photo véhicule) seront demandés via WhatsApp pour validation.
                    </div>
                </div>
            </div>

            <button onclick="submitRegistration()" class="btn-primary w-full py-4 rounded-xl mt-4">Valider l'inscription</button>
        </div>
    </div>

    <div class="screen" id="pendingScreen">
        <div class="p-8 flex flex-col h-full justify-center text-center">
            <div class="w-20 h-20 bg-green-500/20 text-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fab fa-whatsapp text-4xl"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">Finaliser l'inscription</h2>
            <p class="text-gray-400 mb-8">Pour activer votre compte prestataire, veuillez envoyer vos documents via WhatsApp à l'administrateur.</p>
            <button onclick="openWhatsAppValidation()" class="bg-[#25D366] text-white font-bold w-full py-4 rounded-xl mb-4">
                Envoyer mes documents
            </button>
            <button onclick="nav('authScreen')" class="text-sm text-gray-500">Retour</button>
        </div>
    </div>

    <div class="screen" id="homeScreen">
        <div id="map-view"></div> <div class="absolute top-0 left-0 w-full p-4 pt-12 z-10 pointer-events-none">
            <div class="flex justify-between items-start">
                <button onclick="nav('authScreen')" class="w-10 h-10 rounded-full glass flex items-center justify-center text-white pointer-events-auto"><i class="fas fa-bars"></i></button>
                <div class="glass px-4 py-2 rounded-full pointer-events-auto shadow-lg"><span class="w-2 h-2 bg-green-500 rounded-full inline-block mr-2"></span><span class="text-xs font-bold">Antananarivo</span></div>
            </div>
        </div>

        <div class="bottom-sheet open" id="clientSheet">
            <p class="text-xs font-bold text-gray-400 uppercase mb-3">Bonjour <span id="clientNameDisplay">Client</span></p>
            
            <div class="flex gap-2 mb-4">
                <button onclick="setService('vtc')" id="btn-vtc" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold text-sm transition">Maikaville</button>
                <button onclick="setService('loc')" id="btn-loc" class="flex-1 py-3 rounded-xl glass text-gray-400 font-bold text-sm transition">Location</button>
            </div>

            <div class="relative mb-4">
                <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                <input type="text" id="destInput" placeholder="Où allez-vous ?" class="input-field pl-10 bg-slate-800 border-transparent">
            </div>

            <div id="vehicleSelector" class="grid grid-cols-3 gap-2 mb-4">
                <div onclick="selectVeh('moto')" id="v-moto" class="glass p-2 rounded-xl text-center cursor-pointer border border-transparent hover:border-indigo-500">
                    <i class="fas fa-motorcycle text-xl mb-1 text-gray-300"></i><p class="text-[10px] font-bold">Moto</p>
                </div>
                <div onclick="selectVeh('standard')" id="v-standard" class="glass p-2 rounded-xl text-center cursor-pointer border border-indigo-500 bg-indigo-500/10">
                    <i class="fas fa-car text-xl mb-1 text-indigo-400"></i><p class="text-[10px] font-bold">Standard</p>
                </div>
                <div onclick="selectVeh('premium')" id="v-premium" class="glass p-2 rounded-xl text-center cursor-pointer border border-transparent hover:border-yellow-500">
                    <i class="fas fa-shuttle-van text-xl mb-1 text-yellow-500"></i><p class="text-[10px] font-bold">SUV</p>
                </div>
            </div>

            <div class="flex items-center gap-3 mb-4">
                <div class="flex-1">
                    <label class="text-[10px] uppercase font-bold text-gray-500">Votre Offre (Ar)</label>
                    <input type="number" id="priceInput" placeholder="15000" class="input-field font-bold text-lg py-2">
                </div>
                <button onclick="orderRide()" id="btnOrder" class="btn-primary px-8 py-4 rounded-xl h-full flex items-center"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div class="bottom-sheet" id="trackingSheet">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-xl font-bold text-white">Véhicule en approche</h2>
                    <p class="text-indigo-400 font-bold text-lg"><i class="fas fa-clock mr-1"></i> <span id="etaTime">Calcul...</span></p>
                </div>
                <div class="w-14 h-14 bg-slate-700 rounded-full flex items-center justify-center border-2 border-indigo-500">
                    <i class="fas fa-car text-2xl text-white"></i>
                </div>
            </div>
            
            <div class="bg-slate-800 p-4 rounded-xl mb-4 flex justify-between items-center">
                <div>
                    <p class="text-xs text-gray-400">Modèle</p>
                    <p class="font-bold" id="trackModel">Toyota Yaris</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-400">Plaque</p>
                    <p class="font-bold font-mono" id="trackPlate">1234 TBC</p>
                </div>
            </div>

            <button onclick="cancelRide()" class="w-full py-4 rounded-xl glass text-red-400 font-bold">Annuler / Terminer</button>
        </div>
    </div>

    <div class="screen" id="driverScreen">
        <div class="p-4 bg-slate-900 border-b border-slate-800 flex justify-between items-center safe-top">
            <div>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-xs font-bold text-green-500 uppercase">En Ligne</span>
                </div>
                <h1 class="font-bold text-lg">Espace Prestataire</h1>
            </div>
            <button onclick="refreshRides()" class="w-10 h-10 glass rounded-full flex items-center justify-center"><i class="fas fa-sync"></i></button>
        </div>
        
        <div id="ridesList" class="p-4 space-y-3 overflow-y-auto flex-1 bg-slate-900/50">
            <div class="text-center mt-20 opacity-50"><p>En attente de courses...</p></div>
        </div>

        <div id="activeRidePanel" class="hidden absolute bottom-0 w-full bg-slate-800 p-6 rounded-t-3xl border-t border-indigo-500 shadow-2xl">
            <h2 class="text-xl font-bold text-green-400 mb-1">COURSE EN COURS</h2>
            <p class="text-sm text-gray-400 mb-4">Navigation vers le client...</p>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <button onclick="openWaze()" class="glass py-3 rounded-xl flex items-center justify-center gap-2"><i class="fas fa-location-arrow"></i> GPS</button>
                <button onclick="callClient()" class="glass py-3 rounded-xl flex items-center justify-center gap-2"><i class="fas fa-phone"></i> Appel</button>
            </div>
            <button onclick="finishRide()" class="w-full py-4 bg-red-500/20 text-red-400 font-bold rounded-xl border border-red-500/50">TERMINER LA COURSE</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIG ---
        const SUPABASE_URL = 'https://ezlwdyvpyerxgrrvxdwl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6bHdkeXZweWVyeGdycnZ4ZHdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2ODMzNjAsImV4cCI6MjA4MTI1OTM2MH0.6ZFmMAF5rzZ6-XP5Owae-v_SEEnySUScPAyXqRHDiiA';
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let role = 'client'; // 'client' | 'driver'
        let currentPhone = '';
        let map = null, carMarker = null;
        let selectedVehType = 'standard';
        let gpsInterval = null;

        // --- 2. NAVIGATION ---
        function nav(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'homeScreen') initMap();
        }

        setTimeout(() => nav('splashScreen'), 100);
        setTimeout(() => nav('authScreen'), 2500);

        // --- 3. AUTH & REGISTRATION FLOW ---
        function startAuth(selectedRole) {
            role = selectedRole;
            nav('phoneScreen');
        }

        async function checkUser() {
            const phone = document.getElementById('phoneInput').value.replace(/\D/g,'');
            if(phone.length < 5) return showToast("Numéro invalide");
            currentPhone = phone;

            // Vérifie si user existe
            const { data: profiles } = await db.from('profiles').select('*').eq('phone', phone);
            
            if(profiles && profiles.length > 0) {
                // Existe déjà -> Login
                const user = profiles[0];
                if(user.role !== role) return showToast("Ce numéro est enregistré comme " + user.role);
                loginSuccess(user);
            } else {
                // Nouveau -> Inscription
                document.getElementById('regRoleDisplay').innerText = role === 'driver' ? "PRESTATAIRE" : "CLIENT";
                document.getElementById('driverFields').classList.toggle('hidden', role !== 'driver');
                nav('registerScreen');
            }
        }

        function toggleMotoFields() {
            const type = document.getElementById('regVehicleType').value;
            document.getElementById('motoFields').classList.toggle('hidden', type !== 'moto');
        }

        async function submitRegistration() {
            const name = document.getElementById('regName').value;
            const surname = document.getElementById('regSurname').value;
            if(!name) return showToast("Prénom requis");

            let extraData = {};
            if(role === 'driver') {
                extraData = {
                    vehicle_model: document.getElementById('regModel').value,
                    vehicle_type: document.getElementById('regVehicleType').value,
                    license_number: document.getElementById('regLicense').value,
                    service_category: document.getElementById('regService').value,
                    cin_number: document.getElementById('regCin').value,
                    verification_status: 'pending' // En attente validation
                };
                if(!extraData.vehicle_model || !extraData.license_number) return showToast("Infos véhicule requises");
            } else {
                extraData = { verification_status: 'verified' }; // Client validé d'office
            }

            // Fake Auth (Email généré)
            const email = currentPhone + '@' + role + '.maika';
            const password = 'password123';

            // Création Auth + Profile
            const { data: authData, error } = await db.auth.signUp({ email, password });
            
            if(!error) {
                // Update profile avec les infos business
                await db.from('profiles').update({
                    first_name: name,
                    last_name: surname,
                    phone: currentPhone,
                    role: role,
                    ...extraData
                }).eq('id', authData.user.id); // Supabase trigger crée le profil, on l'update

                if(role === 'driver') {
                    nav('pendingScreen'); // Redirection vers WhatsApp validation
                } else {
                    nav('homeScreen');
                }
            } else {
                // Si user existe déjà dans Auth mais pas profil (cas rare), on tente login
                await db.auth.signInWithPassword({ email, password });
                // Et on update le profil... (simplifié ici)
                nav('homeScreen');
            }
        }

        function openWhatsAppValidation() {
            const text = `Bonjour Admin Maika, je souhaite valider mon compte Prestataire.\nNom: ${document.getElementById('regSurname').value}\nTel: ${currentPhone}\nVoici mes documents (Permis, Carte Grise)...`;
            window.open(`https://wa.me/261340000000?text=${encodeURIComponent(text)}`, '_blank');
        }

        async function loginSuccess(user) {
            // Login auto
            const email = user.phone + '@' + user.role + '.maika';
            await db.auth.signInWithPassword({ email, password: 'password123' });
            
            if(user.role === 'driver') {
                if(user.verification_status === 'pending') nav('pendingScreen');
                else nav('driverScreen');
            } else {
                document.getElementById('clientNameDisplay').innerText = user.first_name;
                nav('homeScreen');
            }
        }

        // --- 4. MAP & CLIENT LOGIC ---
        function initMap() {
            if(map) return;
            map = L.map('map-view', { zoomControl: false }).setView([-18.8792, 47.5079], 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        }

        function selectVeh(type) {
            selectedVehType = type;
            document.querySelectorAll('#vehicleSelector > div').forEach(div => div.style.borderColor = 'transparent');
            document.getElementById('v-'+type).style.borderColor = type==='premium'?'#eab308':'#6366f1';
        }

        async function orderRide() {
            const dest = document.getElementById('destInput').value;
            const price = document.getElementById('priceInput').value;
            if(!dest || !price) return showToast("Destination et Prix requis");

            const btn = document.getElementById('btnOrder');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const { data: { user } } = await db.auth.getUser();
            const { data } = await db.from('rides').insert([{
                client_id: user.id,
                destination_address: dest,
                price_proposed: price,
                vehicle_type_requested: selectedVehType,
                status: 'pending'
            }]).select();

            const rideId = data[0].id;
            subscribeToRide(rideId);
            showToast("Recherche de prestataire...");
        }

        // --- 5. REAL-TIME TRACKING (CORE) ---
        function subscribeToRide(rideId) {
            db.channel('ride-'+rideId)
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rides', filter: `id=eq.${rideId}` }, async payload => {
                const ride = payload.new;
                
                // 1. Acceptation
                if(ride.status === 'accepted') {
                    document.getElementById('clientSheet').classList.remove('open');
                    document.getElementById('trackingSheet').classList.add('open');
                    showToast("Prestataire en route !");
                    
                    // Récup info driver
                    const { data: driver } = await db.from('profiles').select('*').eq('id', ride.driver_id).single();
                    if(driver) {
                        document.getElementById('trackModel').innerText = driver.vehicle_model || 'Véhicule';
                        // Calcul ETA basique (simulation)
                        document.getElementById('etaTime').innerText = "4 min"; 
                    }
                }

                // 2. Mouvement Véhicule (L'icône qui bouge)
                if(ride.driver_lat && ride.driver_lng) {
                    updateCarMarker(ride.driver_lat, ride.driver_lng);
                    // Mise à jour ETA (simulation dynamique)
                    document.getElementById('etaTime').innerText = ride.driver_arrival_time || "En approche";
                }
            })
            .subscribe();
        }

        function updateCarMarker(lat, lng) {
            if(!carMarker) {
                const iconHtml = `<div style="font-size:24px; color:#10b981; filter:drop-shadow(0 0 10px #10b981)"><i class="fas fa-car-side"></i></div>`;
                const carIcon = L.divIcon({ html: iconHtml, className: 'car-marker-icon', iconSize: [30,30] });
                carMarker = L.marker([lat, lng], {icon: carIcon}).addTo(map);
            }
            carMarker.setLatLng([lat, lng]); // Leaflet gère la transition si CSS est bon
            map.flyTo([lat, lng], 16);
        }

        // --- 6. DRIVER LOGIC ---
        async function refreshRides() {
            const list = document.getElementById('ridesList');
            list.innerHTML = '...';
            const { data } = await db.from('rides').select('*').eq('status', 'pending').order('created_at', {ascending:false});
            list.innerHTML = '';
            data.forEach(r => {
                const el = document.createElement('div');
                el.className = 'glass p-4 rounded-xl mb-3 border-l-4 border-indigo-500';
                el.innerHTML = `
                    <div class="flex justify-between">
                        <div><h3 class="font-bold">${r.destination_address}</h3><p class="text-xs text-gray-400 uppercase">${r.vehicle_type_requested}</p></div>
                        <div class="text-right"><p class="text-lg font-bold text-green-400">${r.price_proposed} Ar</p><button onclick="acceptRide('${r.id}')" class="btn-primary px-4 py-2 rounded-lg text-sm mt-2">ACCEPTER</button></div>
                    </div>`;
                list.appendChild(el);
            });
        }

        async function acceptRide(id) {
            const { data: { user } } = await db.auth.getUser();
            await db.from('rides').update({ status: 'accepted', driver_id: user.id }).eq('id', id);
            
            // UI Driver
            document.getElementById('ridesList').classList.add('hidden');
            document.getElementById('activeRidePanel').classList.remove('hidden');
            
            // Démarrage GPS
            startGPS(id);
        }

        function startGPS(rideId) {
            if(!navigator.geolocation) return;
            gpsInterval = setInterval(() => {
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    
                    // Envoi position + ETA simulé (pour l'exemple)
                    db.from('rides').update({ 
                        driver_lat: lat, 
                        driver_lng: lng,
                        driver_arrival_time: "2 min" // À calculer réellement plus tard
                    }).eq('id', rideId).then();

                }, err => console.log(err), { enableHighAccuracy: true });
            }, 3000); // 3 secondes
        }

        function finishRide() {
            clearInterval(gpsInterval);
            document.getElementById('ridesList').classList.remove('hidden');
            document.getElementById('activeRidePanel').classList.add('hidden');
            refreshRides();
            showToast("Course terminée !");
        }

        // --- UTILS ---
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 3000);
        }

    </script>
</body>
</html>
